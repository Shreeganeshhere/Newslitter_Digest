# Deployment Guide - Static Frontend on Vercel

This document explains how the project is configured for static frontend deployment on Vercel with automated newsletter generation via GitHub Actions.

## Architecture

- **Frontend**: Static React app deployed on Vercel
- **Backend**: Runs locally on your laptop (or can be deployed separately)
- **Data Flow**: PostgreSQL → JSON export → GitHub → Vercel rebuild

## Setup Steps

### 1. GitHub Secrets Configuration

Add the following secrets to your GitHub repository (Settings → Secrets and variables → Actions):

- `DATABASE_URL`: Your PostgreSQL connection string
- `GEMINI_API_KEY`: Google Gemini API key
- `GMAIL_CREDENTIALS_JSON`: Full contents of your `credentials.json` file (as JSON string)
- `GMAIL_TOKEN_JSON`: Full contents of your `token.json` file (as JSON string)

**Note**: For `GMAIL_CREDENTIALS_JSON` and `GMAIL_TOKEN_JSON`, you need to:
1. Read the entire JSON file content
2. Add it as a secret (GitHub Actions will create the files during workflow execution)

### 2. Local Setup

The backend will continue to run on your laptop. The pipeline will:
1. Fetch newsletters from Gmail
2. Process and summarize them
3. Save to PostgreSQL database
4. Export to `client/src/daily_digest.json`

### 3. GitHub Actions Workflow

The workflow (`.github/workflows/daily-newsletter.yml`) will:
- Run daily at 8:00 AM UTC (configurable via cron schedule)
- Execute the newsletter pipeline
- Export data to JSON
- Commit and push the JSON file to trigger Vercel rebuild

### 4. Vercel Deployment

1. Connect your GitHub repository to Vercel
2. Configure build settings:
   - **Framework Preset**: Vite
   - **Build Command**: `npm run build`
   - **Output Directory**: `dist/public`
   - **Install Command**: `npm install`

3. Vercel will automatically rebuild when:
   - You push code changes
   - GitHub Actions commits the updated `daily_digest.json` file

## File Structure

```
├── .github/
│   └── workflows/
│       └── daily-newsletter.yml    # GitHub Actions cron job
├── client/
│   └── src/
│       ├── daily_digest.json      # Auto-generated by pipeline
│       ├── daily_digest.d.ts       # TypeScript types
│       ├── lib/
│       │   └── dailyDigest.ts      # Helper to read JSON
│       └── pages/
│           └── spaces.tsx          # Updated to use static JSON
├── src/
│   ├── export_to_json.py           # Export script
│   └── run_pipeline.py             # Updated to call export
└── vercel.json                     # Vercel configuration
```

## How It Works

1. **Daily Execution**:
   - GitHub Actions triggers at scheduled time
   - Runs pipeline: Fetch → Clean → Summarize
   - Saves to PostgreSQL
   - Exports to `client/src/daily_digest.json`
   - Commits and pushes JSON file

2. **Frontend**:
   - Reads from `daily_digest.json` (no API calls needed)
   - Fully static, works on Vercel
   - No backend server required for frontend

3. **Manual Trigger**:
   - You can manually trigger the workflow from GitHub Actions tab
   - Or run locally: `python src/run_pipeline.py`

## Testing Locally

1. Run the pipeline:
   ```bash
   python src/run_pipeline.py
   ```

2. Verify JSON file is created:
   ```bash
   cat client/src/daily_digest.json
   ```

3. Test frontend locally:
   ```bash
   npm run dev
   ```

4. Build for production:
   ```bash
   npm run build
   ```

## Troubleshooting

### GitHub Actions Issues

- **Credentials not found**: Ensure secrets are set correctly
- **Database connection failed**: Verify `DATABASE_URL` is correct
- **JSON file not updating**: Check workflow logs for errors

### Vercel Build Issues

- **JSON import error**: Ensure `resolveJsonModule: true` in `tsconfig.json`
- **Build fails**: Check that `daily_digest.json` exists (even if empty)

### Local Pipeline Issues

- **Export fails**: Check database connection and permissions
- **JSON not generated**: Verify `client/src/` directory exists

## Notes

- The `daily_digest.json` file is tracked in git (not in .gitignore)
- GitHub Actions will commit updates automatically
- Vercel rebuilds automatically on git push
- Backend can run independently on your laptop

